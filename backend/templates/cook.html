<!-- C:\Users\leebu\Desktop\recipeverse\templates\cook.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Recipe Generator - RecipeVerse</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      background: #f4f4f4;
      color: #333;
    }
    h1, h2, h3, p {
      text-align: center;
    }
    .container {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .ingredient-btn, .dietary-btn {
      margin: 5px;
      padding: 8px 15px;
      border-radius: 6px;
      border: none;
      background-color: #28a745;
      color: white;
      cursor: pointer;
    }
    .ingredient-btn.selected, .dietary-btn.selected {
      background-color: #218838;
    }
    .ingredient-btn:disabled, .dietary-btn:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    button#rv-generateBtn {
      margin-top: 1rem;
      padding: 10px 20px;
      background: orange;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button#rv-resetBtn {
      margin-top: 1rem;
      padding: 10px 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #rv-result {
      margin-top: 25px;
      background: #d4edda;
      padding: 15px;
      border: 5px solid #ff0000;
      min-height: 150px;
      display: none;
      font-size: 16px;
      white-space: pre-wrap;
      color: #000;
    }
    #rv-result.show {
      display: block;
    }
    #rv-error {
      color: #dc3545;
      display: none;
      margin-top: 10px;
      text-align: center;
    }
    #rv-spinner {
      display: none;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #28a745;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    input, select {
      padding: 0.5rem;
      margin: 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #share-section {
      margin-top: 1rem;
      text-align: center;
    }
    #share-section button {
      margin: 5px;
      padding: 8px 15px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    footer {
      margin-top: 2rem;
      text-align: center;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    {% if current_user.is_authenticated %}
  <h1>Hello {{ current_user.username }} üëã</h1>
  <p style="color: #218838;">You have <span id="rv-credits">{{ current_user.credits }}</span> credits left.</p>
  {% if current_user.subscription_status == 'free' %}
    <p><a href="http://localhost:5000/pricing" style="color: #218838;">Subscribe for unlimited recipes!</a></p>
  {% endif %}
{% else %}
  <h1>Welcome to RecipeVerse</h1>
{% endif %}

    <label for="cuisine">Cuisine Style (optional):</label>
    <select id="cuisine">
      <option value="">Random</option>
      {% for c in cuisines %}
        <option value="{{ c }}">{{ c }}</option>
      {% endfor %}
    </select>

    <h2>Meats & Proteins</h2>
    {% for item in meats %}
      <button class="ingredient-btn" onclick="toggleIng('{{ item }}')">{{ item }}</button>
    {% endfor %}

    <h2>Vegetables</h2>
    {% for item in vegetables %}
      <button class="ingredient-btn" onclick="toggleIng('{{ item }}')">{{ item }}</button>
    {% endfor %}

    <h2>Spices & Herbs</h2>
    {% for item in spices %}
      <button class="ingredient-btn" onclick="toggleIng('{{ item }}')">{{ item }}</button>
    {% endfor %}

    <h2>Base & Carbs</h2>
    {% for item in carbs %}
      <button class="ingredient-btn" onclick="toggleIng('{{ item }}')">{{ item }}</button>
    {% endfor %}

    <h2>‚ûï Add Your Own Ingredient</h2>
    <input type="text" id="customIng" placeholder="e.g., artichoke" />
    <button onclick="addCustomIngredient()">Add Food</button>

    <h2>Dietary Preferences</h2>
    {% for d in dietary %}
      <button class="dietary-btn" onclick="toggleDietary('{{ d }}')">{{ d }}</button>
    {% endfor %}

    <div style="margin-top:1rem;">
      <label>Spiciness: <span id="spiceLabel">3</span>/5</label><br />
      <input type="range" id="spice" min="1" max="5" value="3" oninput="spiceLabel.textContent=this.value" />
    </div>

    <div style="margin-top:1rem;">
      <label>Portions: <span id="portionLabel">2</span></label><br />
      <input type="range" id="portions" min="1" max="10" value="2" oninput="portionLabel.textContent=this.value" />
    </div>

    <h3>Selected Ingredients:</h3>
    <div id="selectedList">None selected</div>

    <button id="rv-generateBtn" onclick="generateRecipe()">Generate Recipe</button>
    <button id="rv-resetBtn" onclick="resetSelection()">Reset Selection</button>

    <div id="rv-error"></div>
    <div id="rv-spinner"></div>
    <div id="rv-result">Your recipe will appear here...</div>

    <div id="share-section">
      <h3>üì£ Share your dish!</h3>
      <button onclick="shareOnTwitter()">Share on X</button>
      <button onclick="shareOnWhatsApp()">WhatsApp</button>
      <button onclick="copyToClipboard()">Copy Link</button>
    </div>
  </div>

  <footer>
    <p>Made with ‚ù§Ô∏è by RecipeVerse ¬∑ ¬© 2025</p>
  </footer>

  <script>
    console.log('RecipeVerse script loaded at:', new Date().toISOString());
    let selectedIngredients = [];
    let selectedDietary = [];

    function toggleIng(item) {
      const index = selectedIngredients.indexOf(item);
      if (index > -1) {
        selectedIngredients.splice(index, 1);
      } else {
        selectedIngredients.push(item);
      }
      updateUI();
    }

    function toggleDietary(label) {
      const index = selectedDietary.indexOf(label);
      if (index > -1) {
        selectedDietary.splice(index, 1);
      } else {
        selectedDietary.push(label);
      }
      console.log('Selected Dietary:', selectedDietary);
      updateUI();
    }

    function addCustomIngredient() {
      const input = document.getElementById('customIng');
      const val = input.value.trim();
      if (val && !selectedIngredients.includes(val)) {
        selectedIngredients.push(val);
        input.value = '';
        updateUI();
      }
    }

    function updateUI() {
      document.querySelectorAll('.ingredient-btn').forEach(btn => {
        btn.classList.toggle('selected', selectedIngredients.includes(btn.textContent.trim()));
      });
      document.querySelectorAll('.dietary-btn').forEach(btn => {
        btn.classList.toggle('selected', selectedDietary.includes(btn.textContent.trim()));
      });
      document.getElementById('selectedList').textContent = selectedIngredients.join(', ') || 'None selected';
      document.getElementById('rv-result').classList.toggle('show', document.getElementById('rv-result').textContent !== 'Your recipe will appear here...');
    }

    function resetSelection() {
      selectedIngredients = [];
      selectedDietary = [];
      document.getElementById('rv-result').textContent = 'Your recipe will appear here...';
      document.getElementById('rv-result').classList.remove('show');
      document.getElementById('rv-error').style.display = 'none';
      document.getElementById('selectedList').textContent = 'None selected';
      document.querySelectorAll('.ingredient-btn, .dietary-btn').forEach(btn => {
        btn.classList.remove('selected');
        btn.disabled = false;
      });
      document.getElementById('rv-generateBtn').disabled = false;
      console.log('Reset clicked');
    }

    async function generateRecipe() {
      console.log('generateRecipe called');
      if (selectedIngredients.length === 0) {
        document.getElementById('rv-error').textContent = 'Please select at least one ingredient.';
        document.getElementById('rv-error').style.display = 'block';
        return;
      }

      document.getElementById('rv-generateBtn').disabled = true;
      document.getElementById('rv-resetBtn').disabled = true;
      document.getElementById('rv-error').style.display = 'none';
      document.getElementById('rv-spinner').style.display = 'inline-block';
      document.getElementById('rv-result').textContent = 'Generating recipe...';
      document.getElementById('rv-result').classList.add('show');

      try {
        const cacheBuster = new Date().getTime();
        const res = await fetch(`/generate?t=${cacheBuster}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ingredients: selectedIngredients,
            dietary: selectedDietary,
            spice_level: parseInt(document.getElementById('spice').value),
            cook_time: 30,
            difficulty: 'easy',
            portions: parseInt(document.getElementById('portions').value),
            cuisine: document.getElementById('cuisine').value
          }),
          credentials: 'include'
        });

        if (!res.ok) {
          if (res.status === 403) {
            window.location.href = '/login';
            return;
          }
          const err = await res.json();
          throw new Error(err.message || 'Generation failed');
        }

        const data = await res.json();
        console.log('Response data:', data);

        if (data.remaining_credits !== undefined) {
          document.getElementById('rv-credits').textContent = data.remaining_credits;
          console.log('Credits updated to:', data.remaining_credits);
        } else if (data.remaining_premium_generations !== undefined) {
          console.log('Premium generations remaining:', data.remaining_premium_generations);
        }

        if (!data.recipe_text) {
          throw new Error('No recipe in response');
        }

        document.getElementById('rv-result').textContent = data.recipe_text;
        document.getElementById('rv-result').classList.add('show');
        console.log('Recipe set:', data.recipe_text);

      } catch (e) {
        console.error('Fetch error:', e.message);
        document.getElementById('rv-result').textContent = 'Error: Failed to generate recipe. Please try again.';
        document.getElementById('rv-error').textContent = e.message;
        document.getElementById('rv-error').style.display = 'block';
      } finally {
        document.getElementById('rv-generateBtn').disabled = false;
        document.getElementById('rv-resetBtn').disabled = false;
        document.getElementById('rv-spinner').style.display = 'none';
      }
    }

    function shareOnTwitter() {
    const text = encodeURIComponent("Check out my custom recipe from RecipeVerse! üç≥ https://recipeverse.com");
    window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
  }

  function shareOnWhatsApp() {
    const text = encodeURIComponent("Check out this cool recipe I made on RecipeVerse! üçΩÔ∏è https://recipeverse.com");
    window.open(`https://api.whatsapp.com/send?text=${text}`, '_blank');
  }

  function copyToClipboard() {
    navigator.clipboard.writeText("https://recipeverse.com").then(() => {
      alert("Link copied to clipboard!");
    });
  }

  function goHome() {
    window.location.href = '/';
  }
  </script>
</body>
</html>